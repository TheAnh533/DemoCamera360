<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>360° HDRI Viewer</title>
    <style>
        body { margin: 0; overflow: hidden; background: black; }
        #info {
          position: absolute; top: 10px; width: 100%;
          text-align: center; color: white; font-family: Arial, sans-serif;
          pointer-events: none; font-size: 16px;
        }
        #loading {
          position: absolute; top: 50%; left: 50%;
          transform: translate(-50%, -50%);
          color: white; font-family: Arial; font-size: 18px;
          background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 6px;
          display: none;
        }
        #controls {
          position: absolute; bottom: 15px; width: 100%; text-align: center;
        }
        #controls button {
          padding: 8px 14px; margin: 0 5px; border: none; border-radius: 6px;
          font-size: 14px; cursor: pointer;
          background: rgba(255,255,255,0.2); color: white;
        }
    </style>
</head>
<body>
<div id="info">360° HDRI Viewer</div>
<div id="loading">Loading HDRI...</div>
<div id="controls">
    <button onclick="prevHDRI()">⏮ Prev</button>
    <button onclick="nextHDRI()">Next ⏭</button>
    <button onclick="toggleRotate()">⏯ Rotate</button>
</div>

<!-- Three.js -->
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/RGBELoader.js"></script>

<script>
    let hdriList = [];
    let currentIndex = 0;
    let scene, camera, renderer, controls, sphere;
    let autoRotate = false;

    // Setup scene
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 2000);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.outputEncoding = THREE.sRGBEncoding;
    document.body.appendChild(renderer.domElement);

    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    camera.position.set(0, 0, 5);

    function loadHDRI(url) {
      document.getElementById('loading').style.display = "block";

      if (sphere) {
        scene.remove(sphere);
        sphere.geometry.dispose();
        sphere.material.dispose();
      }

      new THREE.RGBELoader()
        .setDataType(THREE.UnsignedByteType) // quan trọng để load content://
        .load(url,
          function(texture) {
            texture.mapping = THREE.EquirectangularReflectionMapping;

            const geometry = new THREE.SphereGeometry(500, 60, 40);
            geometry.scale(-1, 1, 1);
            const material = new THREE.MeshBasicMaterial({ map: texture });

            sphere = new THREE.Mesh(geometry, material);
            scene.add(sphere);

            document.getElementById('info').textContent =
              `360° HDRI Viewer - ${url.split('/').pop()} (${currentIndex+1}/${hdriList.length})`;

            document.getElementById('loading').style.display = "none";
          },
          undefined,
          function(err) {
            console.error("HDR load error:", err);
            document.getElementById('loading').textContent = "Load failed!";
          }
        );
    }

    function animate() {
      requestAnimationFrame(animate);
      if (autoRotate && sphere) {
        sphere.rotation.y += 0.002;
      }
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    // Navigation
    function nextHDRI() {
      if (hdriList.length === 0) return;
      currentIndex = (currentIndex + 1) % hdriList.length;
      loadHDRI(hdriList[currentIndex]);
    }

    function prevHDRI() {
      if (hdriList.length === 0) return;
      currentIndex = (currentIndex - 1 + hdriList.length) % hdriList.length;
      loadHDRI(hdriList[currentIndex]);
    }

    function toggleRotate() {
      autoRotate = !autoRotate;
    }

    // Called from Android
    function setHDRList(listJson) {
      try {
        hdriList = typeof listJson === "string" ? JSON.parse(listJson) : listJson;
        if (hdriList.length > 0) {
          currentIndex = 0;
          loadHDRI(hdriList[currentIndex]);
        } else {
          alert("No HDR files found!");
        }
      } catch (e) {
        console.error("Error parsing HDR list:", e);
      }
    }

    // resize
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
</script>
</body>
</html>
